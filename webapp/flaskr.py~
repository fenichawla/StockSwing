# -*- coding: utf-8 -*-
"""
    :copyright: (c) 2014 by Feni Chawla.
    :license: BSD, see LICENSE for more details.
"""

import os
import re
from subprocess import Popen, PIPE
from sqlite3 import dbapi2 as sqlite3
from flask import Flask, request, session, g, redirect, url_for, abort, \
     render_template, flash


# create our little application :)
app = Flask(__name__)

# Load default config and override config from an environment variable
app.config.update(dict(
    DATABASE=os.path.join(app.root_path, 'flaskr.db'),
    DEBUG=True,
    SECRET_KEY='development key',
    USERNAME='admin',
    PASSWORD='default'
))
#app.config.from_envvar('FLASKR_SETTINGS', silent=True)

qs = []

def execqry(qry):
    output = Popen(['./runquery.sh', qry], stdout=PIPE).stdout.read()
    output=(re.sub(u'(?imu)^\s*\n', u'', output))[:-1]
    results = [dict(sym=i.split("\t")[0], var=i.split("\t")[1]) for i in output.split("\n")]
    return results

@app.route("/history")
def history():
    return render_template('history.html', hist=qs)

@app.route("/query", methods=['POST', 'GET'])
def query():
    qry=request.form['query']
    qs.insert(0, qry)
    if qry == 'Who is Gordon Gekko?':
        return render_template('gekko.html')
    else:
        results = execqry(qry)
        return render_template('query_page.html', results=results, prevq=qry)

@app.route("/")
def index():
    return render_template('query_page.html', prevq='')

if __name__ == "__main__":
    app.debug = True
    app.run(host='0.0.0.0')

